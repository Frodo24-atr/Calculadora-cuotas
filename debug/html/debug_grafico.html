<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Gr√°fico - Diagn√≥stico</title>
    
    <!-- CSS de la aplicaci√≥n -->
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/layout.css">
    <link rel="stylesheet" href="assets/css/components.css">
    <link rel="stylesheet" href="assets/css/modals.css">
    <link rel="stylesheet" href="assets/css/charts.css">
    <link rel="stylesheet" href="assets/css/responsive.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <style>
        .debug-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .debug-console {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .test-chart {
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background: white;
        }
        .error { color: #f00; }
        .success { color: #0f0; }
        .warning { color: #ff0; }
        .info { color: #0ff; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Debug Gr√°fico</h1>
            <p>Diagn√≥stico del problema con el gr√°fico</p>
        </div>

        <div class="debug-panel">
            <h3>üß™ Controles de Test</h3>
            <button onclick="verificarChart()" class="btn" style="background: #007bff; margin: 5px;">üìä Verificar Chart.js</button>
            <button onclick="crearProductoTest()" class="btn" style="background: #28a745; margin: 5px;">‚ûï Crear Producto</button>
            <button onclick="testGraficoManual()" class="btn" style="background: #17a2b8; margin: 5px;">üéØ Test Gr√°fico Manual</button>
            <button onclick="limpiarProductos()" class="btn" style="background: #dc3545; margin: 5px;">üßπ Limpiar</button>
            <button onclick="limpiarConsola()" class="btn" style="background: #6c757d; margin: 5px;">üóÇÔ∏è Limpiar Log</button>
        </div>

        <!-- Estado del Gr√°fico -->
        <div class="debug-panel">
            <h3>üìä Estado del Gr√°fico</h3>
            <div id="chart-status"></div>
        </div>

        <!-- Gr√°fico de Prueba -->
        <div class="test-chart">
            <h3>üìà Gr√°fico de Prueba</h3>
            <div class="chart-canvas-wrapper">
                <canvas id="gastosChart"></canvas>
            </div>
        </div>

        <!-- Log Console -->
        <div class="debug-panel">
            <h3>üìú Log de Eventos</h3>
            <div class="debug-console" id="debugLog"></div>
        </div>
    </div>

    <!-- Scripts de la Aplicaci√≥n -->
    <script src="assets/js/utils.js"></script>
    <script src="assets/js/storage.js"></script>
    <script src="assets/js/statistics.js"></script>
    <script src="assets/js/charts.js"></script>
    <script src="assets/js/modals.js"></script>
    <script src="assets/js/products.js"></script>
    <script src="assets/js/app.js"></script>

    <script>
        let testCounter = 1;

        function debugLog(mensaje, tipo = 'info') {
            const debugLogEl = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'success': '#0f0',
                'error': '#f00', 
                'warning': '#ff0',
                'info': '#0ff'
            };
            
            debugLogEl.innerHTML += `<div style="color: ${colors[tipo] || '#fff'}; margin: 2px 0;">[${timestamp}] ${mensaje}</div>`;
            debugLogEl.scrollTop = debugLogEl.scrollHeight;
        }

        function limpiarConsola() {
            document.getElementById('debugLog').innerHTML = '';
            debugLog('üßπ Consola limpiada', 'info');
        }

        function verificarChart() {
            debugLog('üîç === VERIFICACI√ìN CHART.JS ===', 'info');
            
            // 1. Verificar Chart.js
            if (typeof Chart !== 'undefined') {
                debugLog('‚úÖ Chart.js est√° disponible', 'success');
                debugLog(`   Versi√≥n: ${Chart.version || 'No especificada'}`, 'info');
            } else {
                debugLog('‚ùå Chart.js NO est√° disponible', 'error');
            }

            // 2. Verificar canvas
            const canvas = document.getElementById('gastosChart');
            if (canvas) {
                debugLog('‚úÖ Canvas encontrado', 'success');
                debugLog(`   ID: ${canvas.id}`, 'info');
                debugLog(`   Tama√±o: ${canvas.offsetWidth}x${canvas.offsetHeight}`, 'info');
            } else {
                debugLog('‚ùå Canvas NO encontrado', 'error');
            }

            // 3. Verificar funciones
            const funciones = ['actualizarGrafico', 'crearGrafico', 'getProductos'];
            funciones.forEach(func => {
                const existe = typeof window[func] === 'function';
                debugLog(`${existe ? '‚úÖ' : '‚ùå'} ${func}: ${existe ? 'OK' : 'NO ENCONTRADA'}`, existe ? 'success' : 'error');
            });

            // 4. Verificar productos
            try {
                const productos = getProductos();
                debugLog(`üì¶ Productos en storage: ${productos.length}`, 'info');
                productos.forEach((p, i) => {
                    debugLog(`   ${i+1}. ${p.nombre} - $${p.valor}`, 'info');
                });
            } catch (error) {
                debugLog(`‚ùå Error al obtener productos: ${error.message}`, 'error');
            }

            // Actualizar estado
            actualizarEstadoGrafico();
        }

        function crearProductoTest() {
            debugLog(`‚ûï Creando producto test ${testCounter}...`, 'info');
            
            const producto = {
                id: Date.now(),
                nombre: `Producto Test ${testCounter}`,
                valor: 10000 * testCounter,
                cuotas: 6,
                fechaInicio: '2025-01-01',
                valorCuota: (10000 * testCounter) / 6,
                cuotasPagadas: 0
            };

            try {
                const productos = getProductos();
                productos.push(producto);
                saveProductos(productos);
                debugLog(`‚úÖ Producto ${testCounter} creado y guardado`, 'success');
                
                testCounter++;
                
                // Intentar actualizar gr√°fico
                debugLog('üîÑ Intentando actualizar gr√°fico...', 'info');
                if (typeof actualizarGrafico === 'function') {
                    actualizarGrafico();
                    debugLog('‚úÖ actualizarGrafico() llamada', 'success');
                } else {
                    debugLog('‚ùå actualizarGrafico no disponible', 'error');
                }
                
                // Verificar despu√©s de actualizar
                setTimeout(() => {
                    verificarGraficoCreado();
                }, 1000);
                
            } catch (error) {
                debugLog(`‚ùå Error al crear producto: ${error.message}`, 'error');
            }
        }

        function testGraficoManual() {
            debugLog('üéØ === TEST GR√ÅFICO MANUAL ===', 'warning');
            
            try {
                // Verificar que tenemos productos
                const productos = getProductos();
                if (productos.length === 0) {
                    debugLog('‚ö†Ô∏è No hay productos. Creando uno...', 'warning');
                    crearProductoTest();
                    return;
                }

                debugLog(`üìä Probando gr√°fico con ${productos.length} producto(s)`, 'info');
                
                // Llamar directamente a crearGrafico
                if (typeof crearGrafico === 'function') {
                    debugLog('üöÄ Llamando a crearGrafico()...', 'info');
                    crearGrafico();
                    
                    setTimeout(() => {
                        verificarGraficoCreado();
                    }, 500);
                } else {
                    debugLog('‚ùå Funci√≥n crearGrafico no disponible', 'error');
                }
                
            } catch (error) {
                debugLog(`‚ùå Error en test manual: ${error.message}`, 'error');
            }
        }

        function verificarGraficoCreado() {
            debugLog('üîç Verificando si el gr√°fico se cre√≥...', 'info');
            
            const canvas = document.getElementById('gastosChart');
            if (!canvas) {
                debugLog('‚ùå Canvas desaparecido', 'error');
                return;
            }

            // Verificar si Chart.js cre√≥ una instancia
            if (canvas._chartjs) {
                debugLog('‚úÖ Instancia de Chart.js detectada', 'success');
                debugLog(`   Tipo: ${canvas._chartjs.config.type}`, 'info');
                debugLog(`   Datasets: ${canvas._chartjs.data.datasets.length}`, 'info');
            } else {
                debugLog('‚ùå No hay instancia de Chart.js en el canvas', 'error');
            }

            // Verificar el contenido del contenedor
            const wrapper = canvas.parentElement;
            if (wrapper) {
                debugLog(`üìè Contenedor: ${wrapper.innerHTML.length} caracteres`, 'info');
                if (wrapper.innerHTML.includes('No hay datos')) {
                    debugLog('‚ö†Ô∏è Mostrando mensaje de "No hay datos"', 'warning');
                } else if (wrapper.innerHTML.includes('Error')) {
                    debugLog('‚ùå Mostrando mensaje de error', 'error');
                }
            }
        }

        function actualizarEstadoGrafico() {
            const statusEl = document.getElementById('chart-status');
            const productos = getProductos();
            const canvas = document.getElementById('gastosChart');
            
            let html = '<ul style="margin: 0; padding-left: 20px;">';
            
            // Estado de Chart.js
            html += `<li><strong>Chart.js:</strong> ${typeof Chart !== 'undefined' ? '‚úÖ Disponible' : '‚ùå No disponible'}</li>`;
            
            // Estado del canvas
            html += `<li><strong>Canvas:</strong> ${canvas ? '‚úÖ Existe' : '‚ùå No encontrado'}</li>`;
            
            // Estado de productos
            html += `<li><strong>Productos:</strong> ${productos.length} registrados</li>`;
            
            // Estado de la instancia
            if (canvas && canvas._chartjs) {
                html += `<li><strong>Instancia Chart:</strong> ‚úÖ Creada (${canvas._chartjs.config.type})</li>`;
            } else {
                html += `<li><strong>Instancia Chart:</strong> ‚ùå No creada</li>`;
            }
            
            html += '</ul>';
            statusEl.innerHTML = html;
        }

        function limpiarProductos() {
            debugLog('üßπ Limpiando todos los productos...', 'info');
            saveProductos([]);
            testCounter = 1;
            
            if (typeof actualizarGrafico === 'function') {
                actualizarGrafico();
            }
            
            setTimeout(() => {
                verificarChart();
            }, 500);
        }

        // Override console para capturar logs
        const originalConsoleLog = console.log;
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            const mensaje = args.join(' ');
            if (mensaje.includes('gr√°fico') || mensaje.includes('Chart') || mensaje.includes('canvas')) {
                debugLog(`üì° APP: ${mensaje}`, 'info');
            }
        };

        const originalConsoleError = console.error;
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            debugLog(`üí• ERROR: ${args.join(' ')}`, 'error');
        };

        // Inicializaci√≥n
        window.addEventListener('DOMContentLoaded', () => {
            debugLog('üöÄ Debug gr√°fico iniciado', 'success');
            setTimeout(() => {
                verificarChart();
            }, 1000);
        });
    </script>
</body>
</html>
